name: Monthly Login Screenshot

on:
  schedule:
    - cron: "0 0 1 * *"  # 每月1号北京时间8:00运行（UTC+8）
  workflow_dispatch:     # 允许手动触发

jobs:
  screenshot:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Puppeteer
        run: npm install puppeteer nodemailer

      - name: Take screenshot
        env:
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASSWORD }}
          LOGIN_USER: ${{ secrets.LOGIN_USERNAME }}
          LOGIN_PASS: ${{ secrets.LOGIN_PASSWORD }}
        run: |
          node <<EOF
          const puppeteer = require('puppeteer');
          const nodemailer = require('nodemailer');
          const fs = require('fs');

          (async () => {
            // 1. 打开浏览器登录并截图
            const browser = await puppeteer.launch();
            const page = await browser.newPage();
            await page.goto('http://localhost:3000');  // 改成你的页面在线URL
            await page.type('#username', process.env.LOGIN_USER);
            await page.type('#password', process.env.LOGIN_PASS);
            await page.click('#login-button');
            await page.waitForTimeout(2000);  // 等待2秒
            await page.screenshot({ path: 'login.png' });
            await browser.close();

            // 2. 发送邮件
            let transporter = nodemailer.createTransport({
              host: 'smtp.qq.com',
              port: 465,
              secure: true,
              auth: {
                user: process.env.SMTP_USER,
                pass: process.env.SMTP_PASS,
              }
            });

            await transporter.sendMail({
              from: '自动截图机器人 <${process.env.SMTP_USER}>',
              to: process.env.SMTP_USER,
              subject: '【GitHub自动化】登录页面截图',
              text: '本月登录截图已生成，请查收附件',
              attachments: [{
                filename: 'login.png',
                path: 'login.png'
              }]
            });
          })();
          EOF
