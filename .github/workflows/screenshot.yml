name: Monthly Login Screenshot

on:
  schedule:
    - cron: "0 2 1 * *"   # 每月1号上午10点 (北京时间)
    - cron: "0 13 1 * *"  # 每月1号下午9点 (北京时间)
  workflow_dispatch:

jobs:
  screenshot:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Init & Install
        run: |
          npm init -y
          npm install puppeteer nodemailer --no-audit --progress=false

      - name: Take screenshot
        env:
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASSWORD }}
          LOGIN_USER: ${{ secrets.LOGIN_USERNAME }}
          LOGIN_PASS: ${{ secrets.LOGIN_PASSWORD }}
          TARGET_URL: 'https://kqapp.centaline.com.cn/onecard/m/home'
        run: |
          node <<'EOF'
          const puppeteer = require('puppeteer');
          const nodemailer = require('nodemailer');
          const fs = require('fs');

          // 兼容函数：处理不同版本的waitForTimeout
          async function waitForTimeout(page, ms) {
            if (typeof page.waitForTimeout === 'function') {
              return await page.waitForTimeout(ms);
            } else {
              return await new Promise(resolve => setTimeout(resolve, ms));
            }
          }

          (async () => {
            let browser = null;
            try {
              // 检查环境变量
              if (!process.env.SMTP_USER || !process.env.SMTP_PASS) {
                throw new Error('SMTP 邮箱配置未设置');
              }
              if (!process.env.LOGIN_USER || !process.env.LOGIN_PASS) {
                throw new Error('登录账号密码未设置');
              }

              console.log('Launching browser...');
              browser = await puppeteer.launch({
                headless: true,
                args: [
                  '--no-sandbox',
                  '--disable-setuid-sandbox',
                  '--disable-dev-shm-usage',
                  '--window-size=1920,1080'
                ],
                defaultViewport: { width: 1920, height: 1080 }
              });

              const page = await browser.newPage();
              await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 Chrome/120.0.0.0 Safari/537.36');

              console.log('Goto page:', process.env.TARGET_URL);
              await page.goto(process.env.TARGET_URL, { 
                waitUntil: ['networkidle2', 'domcontentloaded'],
                timeout: 60000 
              });

              // 等待页面加载完成
              await waitForTimeout(page, 2000);

              // 尝试查找登录表单元素 - 首先检查是否有iframe
              console.log('Checking if login form is in iframe...');
              const iframes = await page.$$('iframe');
              let loginFrame = null;
              
              for (let i = 0; i < iframes.length; i++) {
                try {
                  const frameContent = await iframes[i].contentFrame();
                  if (frameContent) {
                    const hasUsername = await frameContent.$('#username').catch(() => null);
                    const hasPassword = await frameContent.$('#password').catch(() => null);
                    if (hasUsername || hasPassword) {
                      loginFrame = frameContent;
                      console.log('Found login form in iframe');
                      break;
                    }
                  }
                } catch (err) {
                  // 忽略iframe访问错误
                  console.log('Error accessing iframe:', err.message);
                }
              }

              // 确定操作的上下文（主页面或iframe）
              const context = loginFrame || page;

              // 尝试不同的用户名选择器
              console.log('Finding username field...');
              const usernameSelectors = ['#username', '[name="username"]', '[placeholder*="账号"]', '[placeholder*="用户名"]', '.el-input__inner[placeholder*="账号"]', '#el-id-1154-2', '[id*="el-id-"]'];
              let usernameField = null;
              
              for (const selector of usernameSelectors) {
                try {
                  usernameField = await context.waitForSelector(selector, { timeout: 5000 });
                  if (usernameField) {
                    console.log('Found username field with selector:', selector);
                    break;
                  }
                } catch (err) {
                  console.log('Selector not found:', selector);
                }
              }

              if (!usernameField) {
                throw new Error('未找到用户名输入框');
              }

              // 尝试不同的密码选择器
              console.log('Finding password field...');
              const passwordSelectors = ['#password', '[name="password"]', '[placeholder*="密码"]', '.el-input__inner[placeholder*="密码"]', '#el-id-1154-3', '[id*="el-id-"]'];
              let passwordField = null;
              
              for (const selector of passwordSelectors) {
                try {
                  passwordField = await context.waitForSelector(selector, { timeout: 5000 });
                  if (passwordField) {
                    console.log('Found password field with selector:', selector);
                    break;
                  }
                } catch (err) {
                  console.log('Selector not found:', selector);
                }
              }

              if (!passwordField) {
                throw new Error('未找到密码输入框');
              }

              // 填充登录信息
              console.log('Filling login credentials...');
              await usernameField.focus();
              await usernameField.type(process.env.LOGIN_USER, { delay: 80 });
              await passwordField.focus();
              await passwordField.type(process.env.LOGIN_PASS, { delay: 80 });

              // 尝试不同的登录按钮选择器
              console.log('Finding login button...');
              const loginButtonSelectors = ['#login-button', '#submit', '[type="submit"]', '[name="submit"]', '.login-btn', '.submit-btn', '.el-button--primary', '.h40', '.el-button.el-button--primary.el-button--small.h40'];
              let loginButton = null;
              
              for (const selector of loginButtonSelectors) {
                try {
                  loginButton = await context.waitForSelector(selector, { timeout: 5000 });
                  if (loginButton) {
                    console.log('Found login button with selector:', selector);
                    break;
                  }
                } catch (err) {
                  console.log('Selector not found:', selector);
                }
              }

              if (!loginButton) {
                // 尝试点击所有按钮，看是否有登录功能
                console.log('Trying to find login button by text...');
                const buttons = await context.$$('button');
                for (let i = 0; i < buttons.length; i++) {
                  const buttonText = await buttons[i].evaluate(el => el.textContent || el.innerText || '');
                  const buttonClasses = await buttons[i].evaluate(el => el.className || '');
                  if (buttonText.includes('登录') || buttonText.includes('Login')) {
                    loginButton = buttons[i];
                    console.log('Found login button by text:', buttonText);
                    console.log('Button classes:', buttonClasses);
                    break;
                  } else if (buttonClasses.includes('el-button--primary') || buttonClasses.includes('h40')) {
                    // 尝试使用主要按钮类作为备选
                    loginButton = buttons[i];
                    console.log('Found login button by class:', buttonClasses);
                    console.log('Button text:', buttonText);
                    break;
                  }
                }
              }

              if (!loginButton) {
                throw new Error('未找到登录按钮');
              }

              // 执行登录
              console.log('Clicking login button...');
              const navigationPromise = context.waitForNavigation({
                waitUntil: ['networkidle2', 'domcontentloaded'],
                timeout: 30000
              }).catch(() => {
                console.log('Navigation did not happen - maybe SPA');
              });

              // 检查loginButton是元素句柄还是字符串选择器
              if (typeof loginButton === 'string') {
                // 如果是字符串选择器，使用context.click()
                await context.click(loginButton);
              } else {
                // 如果是元素句柄，直接调用click()方法
                await loginButton.click();
              }
              await navigationPromise;

              // 等待页面加载完成
              await waitForTimeout(page, 3000);

              // 检查是否登录成功（尝试查找登录后才会出现的元素）
              console.log('Checking if login was successful...');
              const loggedInSelectors = [
                '.user-info', '.avatar', '.logout-btn', '[href*="logout"]',
                '.home-page', '.dashboard', '.welcome-message'
              ];
              
              let isLoggedIn = false;
              for (const selector of loggedInSelectors) {
                try {
                  await page.waitForSelector(selector, { timeout: 3000 });
                  isLoggedIn = true;
                  console.log('Login successful! Found logged-in element:', selector);
                  break;
                } catch (err) {
                  // 忽略选择器未找到的错误
                }
              }

              if (!isLoggedIn) {
                console.log('Warning: Could not confirm login success, but proceeding with screenshot');
              }

              // 增加等待时间确保字体和内容完全渲染
              console.log('Waiting for fonts and content to fully render...');
              await waitForTimeout(page, 5000); // 增加渲染等待时间
              
              // 尝试强制重绘页面
              await page.evaluate(() => {
                const body = document.body;
                const display = body.style.display;
                body.style.display = 'none';
                // 强制重排
                void body.offsetHeight;
                body.style.display = display;
              });
              
              // 截图
              const shotPath = 'login_screenshot.png';
              console.log('Taking screenshot to', shotPath);
              await page.screenshot({ 
                path: shotPath, 
                fullPage: true,
                type: 'png',
                captureBeyondViewport: true
              });
              
              console.log('Screenshot taken successfully with enhanced rendering');

              // 发送邮件
              console.log('Preparing email transporter...');
              let transporter = nodemailer.createTransport({
                host: 'smtp.qq.com',
                port: 465,
                secure: true,
                pool: true,
                auth: {
                  user: process.env.SMTP_USER,
                  pass: process.env.SMTP_PASS
                },
                tls: {
                  rejectUnauthorized: false
                }
              });

              console.log('Sending email...');
              const mailOptions = {
                from: `GitHub自动化机器人 <${process.env.SMTP_USER}>`,
                to: process.env.SMTP_USER,
                subject: `【GitHub自动化】${isLoggedIn ? '登录成功' : '登录未知状态'} - 页面截图`,
                text: `自动登录截图已生成\n\n目标网址: ${process.env.TARGET_URL}\n登录账号: ${process.env.LOGIN_USER}\n截图时间: ${new Date().toLocaleString('zh-CN')}\n登录状态: ${isLoggedIn ? '成功' : '未知'}\n\n详情请查看附件`,
                html: `<p>自动登录截图已生成</p><p>目标网址: ${process.env.TARGET_URL}</p><p>登录账号: ${process.env.LOGIN_USER}</p><p>截图时间: ${new Date().toLocaleString('zh-CN')}</p><p>登录状态: ${isLoggedIn ? '成功' : '未知'}</p><p>详情请查看附件</p>`,
                attachments: [
                  {
                    filename: `login_screenshot_${new Date().toISOString().slice(0, 10)}.png`,
                    path: shotPath,
                    cid: 'screenshot@example.com'
                  }
                ]
              };

              await transporter.sendMail(mailOptions);
              console.log('Email sent successfully!');

              console.log('Process completed successfully!');
            } catch (err) {
              console.error('Script failed with error:', err);
              console.error('Error stack:', err.stack);

              // 如果有截图，发送错误邮件
              if (browser && process.env.SMTP_USER && process.env.SMTP_PASS) {
                try {
                  const errorShotPath = 'error_screenshot.png';
                  const page = (await browser.pages())[0];
                  if (page) {
                    await page.screenshot({ path: errorShotPath, fullPage: true });
                    console.log('Error screenshot saved:', errorShotPath);
                  }

                  // 发送错误邮件
                  let transporter = nodemailer.createTransport({
                    host: 'smtp.qq.com',
                    port: 465,
                    secure: true,
                    auth: {
                      user: process.env.SMTP_USER,
                      pass: process.env.SMTP_PASS
                    }
                  });

                  await transporter.sendMail({
                    from: `GitHub自动化机器人 <${process.env.SMTP_USER}>`,
                    to: process.env.SMTP_USER,
                    subject: '【GitHub自动化】登录失败通知',
                    text: `自动登录过程中发生错误\n\n目标网址: ${process.env.TARGET_URL}\n错误时间: ${new Date().toLocaleString('zh-CN')}\n错误信息: ${err.message}\n\n详情请查看附件的错误截图`,
                    html: `<p>自动登录过程中发生错误</p><p>目标网址: ${process.env.TARGET_URL}</p><p>错误时间: ${new Date().toLocaleString('zh-CN')}</p><p>错误信息: ${err.message}</p><p>详情请查看附件的错误截图</p>`,
                    attachments: [
                      {
                        filename: 'error_screenshot.png',
                        path: errorShotPath
                      }
                    ]
                  });
                  console.log('Error email sent successfully!');
                } catch (emailErr) {
                  console.error('Failed to send error email:', emailErr);
                }
              }

              process.exit(1);
            } finally {
              if (browser) {
                await browser.close();
                console.log('Browser closed');
              }
            }
          })();
          EOF